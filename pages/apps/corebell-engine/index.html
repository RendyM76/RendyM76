<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Corebell Engine v0.0.0.02</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
  <style>
    /* Styles omitted for brevity (same as before) */
  </style>
</head>
<body>
  <div id="viewport"></div>

  <div class="control-panel">
    <h2 class="text-xl font-bold mb-4">Corebell Engine v0.0.0.02</h2>
    
    <div class="grid grid-cols-2 gap-2 mb-4">
      <button class="btn btn-blue" onclick="addObject('cube')">Cube</button>
      <button class="btn btn-blue" onclick="addObject('sphere')">Sphere</button>
      <button class="btn btn-blue" onclick="addObject('cylinder')">Cylinder</button>
      <button class="btn btn-red" onclick="deleteSelected()">Delete</button>
    </div>

    <div class="mb-4">
      <div class="text-sm font-medium mb-2">Transform Mode</div>
      <div class="grid grid-cols-3 gap-2">
        <button class="toggle-btn active" onclick="setTransformMode('translate')">Translate</button>
        <button class="toggle-btn" onclick="setTransformMode('rotate')">Rotate</button>
        <button class="toggle-btn" onclick="setTransformMode('scale')">Scale</button>
      </div>
    </div>

    <div class="mb-4">
      <div class="text-sm font-medium mb-2">Scene Settings</div>
      <div class="flex items-center gap-2 mb-2">
        <button class="toggle-btn active" onclick="toggleGrid()">Grid</button>
        <input type="range" class="slider" min="0" max="2" step="0.1" value="1" onchange="setLightIntensity(this.value)">
      </div>
      <div class="flex items-center gap-2">
        <input type="color" value="#ffffff" onchange="setObjectColor(this.value)" class="flex-1 h-8">
      </div>
    </div>

    <div class="grid grid-cols-2 gap-2">
      <button class="btn btn-blue" onclick="saveScene()">Save</button>
      <input type="file" id="loadSceneInput" accept=".json" style="display:none;" onchange="loadScene(this.files[0])">
      <button class="btn btn-blue" onclick="document.getElementById('loadSceneInput').click()">Load</button>
    </div>
  </div>

  <div class="stats-panel">
    <div>FPS: <span id="fps" class="stats-value">60</span></div>
    <div>Objects: <span id="objectCount" class="stats-value">0</span></div>
    <div>Triangles: <span id="triangles" class="stats-value">0</span></div>
  </div>

  <div id="notification" class="notification">Object added to scene!</div>

  <!-- Load Three.js and dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.146.0/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.146.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.146.0/examples/js/controls/TransformControls.js"></script>

  <script>
    let scene, camera, renderer, controls, transformControls, world;
    const objects = [];
    let selectedObject = null;
    let lastTime = performance.now();
    let gridHelper;
    let directionalLight;

    // Initialize Engine
    function init() {
      // Scene setup (same as before)

      // Initialize other elements (same as before)
      animate();
    }

    function saveScene() {
      const sceneData = objects.map(obj => ({
        type: obj.mesh.geometry.type,
        position: obj.mesh.position.clone(),
        rotation: obj.mesh.rotation.clone(),
        scale: obj.mesh.scale.clone(),
        color: `#${obj.mesh.material.color.getHexString()}`
      }));

      const dataStr = JSON.stringify(sceneData, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'scene.json';
      link.click();
    }

    function loadScene(file) {
      const reader = new FileReader();
      reader.onload = function(event) {
        const sceneData = JSON.parse(event.target.result);

        // Clear existing objects
        objects.forEach(obj => {
          scene.remove(obj.mesh);
          world.removeBody(obj.body);
        });
        objects.length = 0;

        // Load objects from sceneData
        sceneData.forEach(data => {
          let geometry, shape;
          switch (data.type) {
            case 'BoxGeometry':
              geometry = new THREE.BoxGeometry(1, 1, 1);
              shape = new CANNON.Box(new CANNON.Vec3(0.5, 0.5, 0.5));
              break;
            case 'SphereGeometry':
              geometry = new THREE.SphereGeometry(0.5, 32, 32);
              shape = new CANNON.Sphere(0.5);
              break;
            case 'CylinderGeometry':
              geometry = new THREE.CylinderGeometry(0.5, 0.5, 1, 32);
              shape = new CANNON.Cylinder(0.5, 0.5, 1, 32);
              break;
          }

          const material = new THREE.MeshStandardMaterial({ color: data.color });
          const mesh = new THREE.Mesh(geometry, material);
          mesh.position.copy(data.position);
          mesh.rotation.copy(data.rotation);
          mesh.scale.copy(data.scale);
          mesh.castShadow = true;
          scene.add(mesh);

          const body = new CANNON.Body({ mass: 1 });
          body.addShape(shape);
          body.position.copy(data.position);
          world.addBody(body);

          objects.push({ mesh, body });
        });

        showNotification('Scene loaded!');
      };
      reader.readAsText(file);
    }

    init();
  </script>
</body>
</html>
